var zNodes10,zNodes11;var departmentIds="";var inner_open=false,out_open=false;function init(){if("内部考试"==examType){searchDepartmentTree()}if("外部考试"==examType){queryBigNameAndId();queryHaulUnit();queryExamEmployees()}searchPaper()}$(function(){init();$("#querBtn").click(function(){$("#currentPage").val("");searchPaper()});$("[name='examMethod']").click(function(){if($(this).val()=="线上"){$("#inpstart0").val("");$("#inpend0").val("")}if($(this).val()=="线下"){$("#inpstart0").val(Format(getServerDate(),"yyyy-MM-dd HH:mm:ss"));$("#inpend0").val(Format(getServerDate(),"yyyy-MM-dd HH:mm:ss"))}});$("#el_chooseDepart1").click(function(){$("#treeDemo10").toggle()});$("#selectEmployeeIn").click(function(){queryInnerEmployee()});$("#selectEmployeeOut").click(function(){queryOutEmployee()});$("#queryOutBtn").click(function(){queryOutEmployee()});$("#queryInnerBtn").click(function(){queryInnerEmployee()});$("#innerEmployeeModal").on("hidden.bs.modal",function(){inner_open=false});$("#outEmployeeModal").on("hidden.bs.modal",function(){out_open=false});$("#okInnerEmployee").click(function(){seleInnerEmployee()});$("#okOutEmployee").click(function(){selectOutEmployee()});$("#updateExamBtn").click(function(){updateExam()})});var searchDepartmentTree=function(){$.ajax({url:contextPath+"/exam_getDepartmentTree.action",async:true,dataType:"json",success:function(a){zNodes10=a.departmentTrees;geneDepartmentTree(zNodes10)},error:function(){alert("查询内部部门树失败！！！")}})};function geneDepartmentTree(b){$("#treeDemo10").html("");var a={view:{selectedMulti:false},check:{enable:true,chkboxType:{Y:"",N:""}},data:{simpleData:{enable:true,idKey:"departmentid",pIdKey:"updepartmentid",rootPId:null},key:{name:"departmentname",}},callback:{beforeCheck:beforeCheck,onClick:zTreeOnClick,onCheck:zTreeOnCheck}};var c=b;$.fn.zTree.init($("#treeDemo10"),a,c);queryExamEmployees()}function zTreeOnClick(a,c,b){}function zTreeOnCheck(a,c,b){}var el_chooseDepart1,className10="dark",el_id;function beforeCheck(b,a){className10=(className10==="dark"?"":"dark");el_id=a.departmentname;if(!a.checked){departmentIds+=a.departmentid+",";showLog10(a.departmentname+",");$("#department_employee_in").append('<div class="panel panel-default el_departPersons" id="'+a.departmentname+'"><div class="panel-heading"><span class="el_addDepart" >'+a.departmentname+'</span>&nbsp;&nbsp;(人数：<span class="employeeNum">0</span>)</div><div class="panel-body"></div></div>')}else{departmentIds=departmentIds.replace(a.departmentid+",","");$("#"+a.departmentname).remove();noshowLog10(a.departmentname+",",a);var c=a.getParentNode()}return(a.doCheck!==false)}function showLog10(a){if(!el_chooseDepart1){el_chooseDepart1=$("#el_chooseDepart1")}el_chooseDepart1.append("<li class='"+className10+"' id='"+el_id+"'>"+a+"</li>")}function noshowLog10(e,d){if(!el_chooseDepart1){el_chooseDepart1=$("#el_chooseDepart1")}el_chooseDepart1.children("#"+el_id).remove();if(d.isParent){var a=d.children;if(a){for(var b=0;b<a.length;b++){var c=a.departmentName;el_chooseDepart1.children("#"+c).remove()}}}}function searchPaper(){$.ajax({url:"findPaper_findPapers.action",data:{currentPage:$("#currentPage").val(),currentCount:$("#currentCount").val(),title:$("#title").val(),level:$("#level option:selected").val(),paperStatus:$("#paperStatus option:selected").val()},type:"POST",async:true,dataType:"text",success:showTable,error:function(){alert("请求失败！")}})}function showTable(data){var result=eval("("+data+")");$("#paperTableBody").html("");var papers=result.pageBean.productList;for(var i=0,length=papers.length;i<length;i++){$("#paperTableBody").append("<tr><td><input type='radio' onclick='setPaperIdValue()' name='exam.paperid_1' value='"+papers[i].paperid+"'/></td><td>"+papers[i].title+"</td><td>"+papers[i].level+"</td><td>"+papers[i].paperscore+"</td><td>"+papers[i].usetimes+"</td><td>"+papers[i].description+"</td><td>"+papers[i].employeename+"</td><td>"+papers[i].maketime+"</td><td><a href='/Exam/findPaper_findPaperAllInfoById.action?paperId="+papers[i].paperid+"' target='_blank'>试卷预览</a></td></tr>")}initPaper();var currentPage=result.pageBean.currentPage;var totalCount=result.pageBean.totalCount;var currentCount=result.pageBean.currentCount;page(currentPage,totalCount,currentCount)}var setPaperIdValue=function(){$("[name='exam.paperid']").val($("[name='exam.paperid_1']:checked").val())};function page(c,a,b){$("#paginationID").pagination({total:a,pageSize:b,pageNumber:c,pageList:[8,15,20],layout:["list","sep","first","prev","manual","next","last","links"],onSelectPage:function(e,d){$("#currentPage").val(e);$("#currentCount").val(d);searchPaper()}})}var initPaper=function(){var c=$("[name='exam.paperid_1']");for(var a=0,b=c.length;a<b;a++){if($(c[a]).val()==examPaperId){$(c[a]).attr("checked","checked")}}};var queryExamEmployees=function(){$.ajax({url:contextPath+"/findExam_findExamEmployeeByExamId.action",data:{examId:examId},type:"POST",async:true,dataType:"json",success:showExamEmployees,error:function(){alert("查询考试员工信息失败！！！")}})};function showExamEmployees(a){var b=a.employees;if(b!=null&&b.length>0){if(b[0].employeeType=="0"){showInDepartment(b)}else{showOutUnit(b)}}}var showInDepartment=function(m){var n=[];var l=0;for(var h=0,d=m.length;h<d;h++){if(h==0){n[l]=m[0].unitName;l++;continue}if(m[h].unitName!=m[h-1].unitName){n[l]=m[h].unitName;l++}}var e=$.fn.zTree.getZTreeObj("treeDemo10");var a=e.transformToArray(e.getNodes());for(var g=0,c=n.length;g<c;g++){$("#department_employee_in").append('<div class="panel panel-default el_departPersons" id="'+n[g]+'"><div class="panel-heading"><span class="el_addDepart" >'+n[g]+'</span>&nbsp;&nbsp;(人数：<span class="employeeNum">0</span>)</div><div class="panel-body"></div></div>');$("#el_chooseDepart1").append('<li id="'+n[g]+'" class="">'+n[g]+",</li>");for(var f=0,b=a.length;f<b;f++){if(n[g]==a[f].departmentName){a[f].checked="true";departmentIds+=a[f].departmentId+",";break}}}showInEmployees(m)};var showInEmployees=function(c){for(var a=0,b=c.length;a<b;a++){$("#"+c[a].unitName+" .panel-body").append('<span class="el_empList" id="'+c[a].idCode+'">'+c[a].name+'<img class="el_empDelete" src="'+contextPath+'/image/delete.png" /></span>');$("#"+c[a].unitName+" .employeeNum").text(parseInt($("#"+c[a].unitName+" .employeeNum").text())+1)}};var showOutUnit=function(f){var a=[];var g=0;for(var c=0,e=f.length;c<e;c++){if(c==0){a[g]=f[0].unitName;g++;continue}if(f[c].unitName!=f[c-1].unitName){a[g]=f[c].unitName;g++}}for(var b=0,d=a.length;b<d;b++){$("#department_employee_out").append('<div class="panel panel-default el_departPersons" id="'+a[b]+'"><div class="panel-heading"><span class="el_addDepart" >'+a[b]+'</span>&nbsp;&nbsp;(人数：<span class="employeeNum">0</span>)</div><div class="panel-body"></div></div>');$("#el_chooseUnit").append("<li class='"+a[b]+"' id='"+a[b]+"'>"+a[b]+",</li>");$("#haulUnitDiv :checkbox").each(function(h){if($(this).siblings("span").text()==a[b]){$(this).attr("checked","true")}})}showOutEmployees(f)};var showOutEmployees=function(c){console.log(c);for(var a=0,b=c.length;a<b;a++){$("#department_employee_out #"+c[a].unitName+" .panel-body").append('<span class="el_empList" id="'+c[a].idCode+'">'+c[a].name+'<img class="el_empDelete" src="'+contextPath+'/image/delete.png" /></span>');$("#department_employee_out #"+c[a].unitName+" .employeeNum").text(parseInt($("#department_employee_out #"+c[a].unitName+" .employeeNum").text())+1)}};var queryOutEmployee=function(){var b=$("#el_chooseUnit").text();var a=$("#exam_level").val();if(a==""){alert("请先选择考试级别");return}if(b.length>0){b=b.substring(0,b.length-1);$("input[name='queryOuterEmployeesCondition.units']").val(b);ajaxQueryEmployeeOut()}else{alert("至少选择一个外部单位");return}};var ajaxQueryEmployeeOut=function(){$.ajax({url:contextPath+"/exam_getEmployeeOuts4Exam.action",data:$("#queryOutForm").serialize(),type:"POST",dataType:"json",success:showEmployeeOutModal,error:function(){alert("查询外来员工出错！！！")}})};function showEmployeeOutModal(b){$("#outEmployeeTable").html("");var h=b.examEmployeeOuts;for(var c=0,f=h.length;c<f;c++){var e=h[c].sex=="1"?"男":"女";var g=h[c].trainStatus;var d;var a='<tr><td><input type="checkbox" name="employeeOut" value="'+h[c].idCode+'" class="el_checks" /></td><td>'+h[c].name+"</td><td>"+e+"</td><td>"+h[c].idCode+"</td><td>"+h[c].unitname+"</td><td>"+h[c].empType+"</td><td>"+h[c].minusNum+'<input type="hidden" class="unitId" value="'+h[c].unitId+'"/><input type="hidden" class="bigemployeeoutid" value="'+h[c].bigemployeeoutid+'"/><input type="hidden" class="distributeid" value="'+h[c].distributeid+'"/> </td></tr>';$("#outEmployeeTable").append(a)}checkOutHasChecked();if(!out_open){$("#outEmployeeModal").modal({backdrop:"static",keyboard:false});out_open=true}}var checkOutHasChecked=function(){var b=$("#department_employee_out").find(".el_empList");var l=[];for(var h=0,c=b.length;h<c;h++){l[h]=b[h].id}var a=$("#outEmployeeTable").find(".el_checks");for(var f=0,e=l.length;f<e;f++){for(var g=0,d=a.length;g<d;g++){if(l[f]==a[g].value){a[g].checked="checked";break}}}};var selectOutEmployee=function(){$("[name='employeeFlag']").val("111");var n=$("input[name='employeeOut']:checked");$("#outEmployeeDiv").html("");var q=$("#department_employee_out").find(".panel-body");for(var h=0,e=q.length;h<e;h++){$(q[h]).html("")}var m=$("#department_employee_out").find(".employeeNum");for(var f=0,e=q.length;f<e;f++){$(m[f]).text("0")}for(var l=0,d=n.length;l<d;l++){var c=$(n[l]).parents("tr").children("td").eq("4").html();var p=$(n[l]).parents("tr").children("td").eq("3").html();var o=$(n[l]).parents("tr").children("td:last").find(".distributeid").val();var a=$(n[l]).parents("tr").children("td:last").find(".bigemployeeoutid").val();var g=$(n[l]).parents("tr").children("td:last").find(".unitId").val();var b=$(n[l]).parents("tr").children("td").eq("1").html();$("#"+c+" .panel-body").append('<span class="el_empList" id="'+p+'">'+b+'<img class="el_empDelete" src="'+contextPath+'/image/delete.png" /></span>');$("#"+c+" .employeeNum").text(parseInt($("#"+c+" .employeeNum").text())+1);var r=$(n[l]).val();$("#outEmployeeDiv").append('<input type="hidden" name="exam.employeeOutExams['+l+'].employeeid" value="'+r+'"/>');$("#outEmployeeDiv").append('<input type="hidden" name="exam.employeeOutExams['+l+'].employeename" value="'+b+'"/>');$("#outEmployeeDiv").append('<input type="hidden" name="exam.employeeOutExams['+l+'].unitid" value="'+g+'"/>');$("#outEmployeeDiv").append('<input type="hidden" name="exam.employeeOutExams['+l+'].distributeid" value="'+o+'"/>');$("#outEmployeeDiv").append('<input type="hidden" name="exam.employeeOutExams['+l+'].bigemployeeoutid" value="'+a+'"/>')}$("#innerEmployeeDiv").html("");$("#outEmployeeModal").modal("hide")};var queryInnerEmployee=function(){var a=$("#el_chooseDepart1").text();if(a.length>0){a=departmentIds.substring(0,departmentIds.length-1);$("input[name='queryInnerEmployeesCondition.departments']").val(a);ajaxQueryEmployeeIn(a)}else{alert("至少选择一个部门");return}};var ajaxQueryEmployeeIn=function(a){$.ajax({url:contextPath+"/exam_getEmployeeIns4Exam.action",data:$("#queryInnerForm").serialize(),type:"POST",dataType:"json",success:showEmployeeInModal,error:function(){alert("查询内部员工出错！！！")}})};function showEmployeeInModal(b){$("#innerEmployeeTable").html("");var f=b.examEmployeeIns;for(var c=0,e=f.length;c<e;c++){var d=f[c].sex=="1"?"男":"女";var a='<tr><td><input type="hidden" class="departmentId" value="'+f[c].departmentId+'"/><input type="checkbox" name="employeeIn" value="'+f[c].idcode+'" class="el_checks" /></td><td>'+f[c].name+"</td><td>"+d+"</td><td>"+f[c].idcode+"</td><td>"+f[c].departmentname+"</td></tr>";$("#innerEmployeeTable").append(a)}checkInHasChecked();if(!inner_open){$("#innerEmployeeModal").modal({backdrop:"static",keyboard:false});inner_open=true}}var checkInHasChecked=function(){var g=$("#department_employee_in").find(".el_empList");var l=[];for(var f=0,a=g.length;f<a;f++){l[f]=g[f].id}var h=$("#innerEmployeeTable").find(".el_checks");for(var d=0,c=l.length;d<c;d++){for(var e=0,b=h.length;e<b;e++){if(l[d]==h[e].value){h[e].checked="checked";break}}}};var seleInnerEmployee=function(){if(confirm("确认选择这些员工?")){$("[name='employeeFlag']").val("111");var a=$("input[name='employeeIn']:checked");$("#innerEmployeeDiv").html("");var b=$("#department_employee_in").find(".panel-body");for(var g=0,d=b.length;g<d;g++){$(b[g]).html("")}var e=$("#department_employee_in").find(".employeeNum");for(var f=0,d=e.length;f<d;f++){$(e[f]).text("0")}for(var h=0,c=a.length;h<c;h++){var o=$(a[h]).parents("tr").children("td").eq(0).find(".departmentId").val();var l=$(a[h]).parents("tr").children("td").eq("4").html();var n=$(a[h]).parents("tr").children("td").eq("3").html();var m=$(a[h]).parents("tr").children("td").eq("1").html();$("#"+l+" .panel-body").append('<span class="el_empList" id="'+n+'">'+m+'<img class="el_empDelete" src="'+contextPath+'/image/delete.png" /></span>');$("#"+l+" .employeeNum").text(parseInt($("#"+l+" .employeeNum").text())+1);var p=$(a[h]).val();$("#innerEmployeeDiv").append('<input type="hidden" name="exam.employeeInExams['+h+'].employeeid" value="'+p+'"/>');$("#innerEmployeeDiv").append('<input type="hidden" name="exam.employeeInExams['+h+'].employeename" value="'+m+'"/>');$("#innerEmployeeDiv").append('<input type="hidden" name="exam.employeeInExams['+h+'].unitid" value="'+o+'"/>')}$("#outEmployeeDiv").html("");$("#innerEmployeeModal").modal("hide")}};var updateExam=function(){if(confirm("确认修改考试并退出?")){$.validator.methods.compareDate=function(f,c,g){var b=$("#inpstart0").val();var e=new Date(b);var d=new Date(f);return e<=d};var a=$("#updateForm").validate({ignore:[],rules:{"exam.paperid":"required","exam.examname":{required:true},"exam.traincontent":{required:true},"exam.xueshi":{required:true,digits:true},"exam.answertime":{required:true,digits:true,range:[20,400]},"exam.address":"required","exam.starttime":"required","exam.endtime":{required:true,compareDate:"#inpend0"},"exam.employeename":{required:true},employeeFlag:"required"},messages:{"exam.paperid":{required:"必须选择一份考试试卷"},"exam.examname":{required:"考试名称不能为空"},"exam.traincontent":{required:"培训内容不能为空"},"exam.xueshi":{required:"培训时长不能为空",digits:"必须输入整数"},"exam.answertime":{required:"考试时长不能为空",digits:"考试时长必须是整数",range:"考试时长必须在20到400分钟范围内"},"exam.address":"考试地址不能为空","exam.starttime":"开始时间不能为空","exam.endtime":{required:"结束时间不能为空",compareDate:"结束日期不能小于开始日期"},"exam.employeename":{required:"创建人不能为空"},employeeFlag:"必须选择参考员工"}});if(a.form()){$("#updateExamBtn").prop("disabled",true);$.ajax({url:contextPath+"/UpdateExam_update.action",data:$("#updateForm").serialize(),type:"POST",dataType:"json",async:true,success:function(b){alert(b.updateResult);if(b.updateResult=="修改成功!"){window.location.href=contextPath+"/view/examParper/exam/examManage.jsp"}},error:function(){alert("修改考试失败！！！")}})}}};function queryBigNameAndId(){$.post(contextPath+"/haul_getHaulNameAndIdsForExam.action",add2Select,"json")}function add2Select(a){if(a!=null&&a.haulNameAndIds!=null){var c=a.haulNameAndIds;for(var b=0,e=c.length;b<e;b++){$("#bigName").append('<option value="'+c[b].bigId+'">'+c[b].bigName+"</option>")}var d=$(":hidden[name='exam.bigid']").val();$("#bigName").val(d)}}function queryHaulUnit(){var a=$(":hidden[name='exam.bigid']").val();$("[name='queryOuterEmployeesCondition.bigId']").val(a);$.post(contextPath+"/unit_getUnitidsAndNamesByHaulId.action",{bigId:a},function(c){$("#haulUnitDiv").html("");if(c!=null&&c.unitidsAndNames!=null){var b=c.unitidsAndNames;for(var d=0,e=b.length;d<e;d++){$("#haulUnitDiv").append('<span><input type="checkbox" value="'+b[d].unitId+'" style="margin-left: 20px;" /><span>'+b[d].name+"</span></span>")}}},"json")}function openUnitModal(){$("#unitModal").modal({keyboard:false,backdrop:"static"})}function addUnit2Input(){$("#haulUnitDiv :checkbox").each(function(d){var e=$(this).val();var c=$(this).siblings("span").text();var b=$("#department_employee_out").children("#"+c);var a=$("#el_chooseUnit").children("#"+c);if($(this).prop("checked")==false){if(b.length==1&&a.length==1){$("#department_employee_out").children("#"+c).remove();$("#el_chooseUnit").children("#"+c).remove()}}else{if(b.length==0&&a.length==0){$("#department_employee_out").append('<div class="panel panel-default el_departPersons" id="'+c+'"><div class="panel-heading"><span class="el_addDepart" >'+c+'</span>&nbsp;&nbsp;(人数：<span class="employeeNum">0</span>)</div><div class="panel-body"></div></div>');$("#el_chooseUnit").append("<li class='"+c+"' id='"+c+"'>"+c+",</li>")}}});$("#unitModal").modal("hide")}function queryPaper(b){var a=$(b).children("option:selected").val();$("#paper_level").val(a);$("[name='exam.paperid']").val("");$("#level option[value='"+a+"']").prop("selected","selected");$("[name='queryOuterEmployeesCondition.trainStatus']").val((parseInt(a)).toString());searchPaper()}+function initEmployeeTypeDic(){$.post(contextPath+"/dic_getDicNamesByUpid.action",{upId:"100"},showEmployeeTypeDic,"json")}();function showEmployeeTypeDic(a){if(a!=null&&a.names!=null){var c=a.names;for(var b=0;b<c.length;b++){$("#employType").append('<option value="'+c[b]+'">'+c[b]+"</option>")}}}function getServerDate(){var a;$.ajax({url:"onlineExam_getNowServerTime.action?date="+Format(new Date(),"HH:mm:ss"),async:false,datatype:"json",success:function(b){a=b.nowTime.replace(/T/g," ").replace(/-/g,"/")}});return new Date(a)}function allSecectAndNotSelect(a){$(".el_checks").prop("checked",$(a).prop("checked"))};