var departIndex=0;var departmentIds="";var inner_open=false,out_open=false;var departmentr4Query=[];$(function(){initSomdeThing();$(".el_empList").hover(function(){$(this).children(".el_empDelete").show()},function(){$(this).children(".el_empDelete").hide()});$(".el_empList").click(function(){$(this).remove()});$(".el_radioBox2").click(function(){departIndex=$(this).children().val()});$(".el_checkQuanxuan").change(function(){if($(this).prop("checked")==true){$(".el_checks").prop("checked","true")}else{$(".el_checks").removeAttr("checked")}});$("#el_addExamSubmit").click(function(){confirm("取消将不保存当前修改信息，确定取消吗？")});$("#okInnerEmployee").click(function(){seleInnerEmployee()});$("#okOutEmployee").click(function(){selectOutEmployee()});$("#selectEmployeeIn").click(function(){queryInnerEmployee()});$("#selectEmployeeOut").click(function(){queryOutEmployee()});$("#saveExamBtn").click(function(){saveExam()});$("#queryInnerBtn").click(function(){queryInnerEmployee()});$("#queryOutBtn").click(function(){queryOutEmployee()});$("#innerEmployeeModal").on("hidden.bs.modal",function(){inner_open=false});$("#outEmployeeModal").on("hidden.bs.modal",function(){out_open=false});$("#openInRadio").click(function(){$("#addInDiv").css("display","block");$(".inShow").css("display","");$(".outShow").css("display","none");$("#addOutDiv").css("display","none");$(":radio[value='线上']").prop("disabled",false);$(":radio[value='线上']").prop("checked",true);$("#inpstart0").val("");$("#inpend0").val("")});$("[name='examMethod']").click(function(){if($(this).val()=="线上"){$("#inpstart0").val("");$("#inpend0").val("")}if($(this).val()=="线下"){var b=getServerDate().getTime();var a=b+45*60*1000;$("#inpstart0").val(Format(new Date(b),"yyyy-MM-dd HH:mm:ss"));$("#inpend0").val(Format(new Date(a),"yyyy-MM-dd HH:mm:ss"))}});$("#openOutRadio").click(function(){$("#addInDiv").css("display","none");$(".inShow").css("display","none");$(".outShow").css("display","");$("#addOutDiv").css("display","");$(":radio[value='线上']").prop("disabled",true);$(":radio[value='线下']").prop("checked",true);var b=getServerDate().getTime();var a=b+45*60*1000;$("#inpstart0").val(Format(new Date(b),"yyyy-MM-dd HH:mm:ss"));$("#inpend0").val(Format(new Date(a),"yyyy-MM-dd HH:mm:ss"))});queryBigNameAndId();$("#selectUnitBtn").click(function(){addUnit2Input()});$(document).click(function(a){if($(a.target).attr("class")!="unitName"){if($("#showDiv").css("display")=="block"){$("#showDiv").css("display","none")}}})});function initSomdeThing(){initEmployeeTypeDic();var b=getServerDate().getTime();var a=b+45*60*1000;$("#inpstart0").val(Format(new Date(b),"yyyy-MM-dd HH:mm:ss"));$("#inpend0").val(Format(new Date(a),"yyyy-MM-dd HH:mm:ss"));$("#addInDiv").css("display","none");$(".inShow").css("display","none");$(".outShow").css("display","");$("#addOutDiv").css("display","");$(":radio[value='线上']").prop("disabled",true)}var queryInnerEmployee=function(){var a=departmentIds;if(a.length>0){a=a.substring(0,a.length-1);$("input[name='queryInnerEmployeesCondition.departments']").val(a);ajaxQueryEmployeeIn(a)}else{alert("至少选择一个部门");return}};var ajaxQueryEmployeeIn=function(a){$.ajax({url:contextPath+"/exam_getEmployeeIns4Exam.action",data:$("#queryInnerForm").serialize(),type:"POST",dataType:"json",success:showEmployeeInModal,error:function(){alert("查询内部员工出错！！！")}})};function showEmployeeInModal(b){$("#innerEmployeeTable").html("");var f=b.examEmployeeIns;for(var c=0,e=f.length;c<e;c++){var d=f[c].sex=="1"?"男":"女";var a='<tr><td><input type="hidden" class="departmentId" value="'+f[c].departmentId+'"/><input type="checkbox" name="employeeIn" value="'+f[c].idcode+'" class="el_checks" /></td><td>'+f[c].name+"</td><td>"+d+"</td><td>"+f[c].idcode+"</td><td>"+f[c].departmentname+"</td></tr>";$("#innerEmployeeTable").append(a)}checkInHasChecked();if(!inner_open){$("#innerEmployeeModal").modal({backdrop:"static",keyboard:false});inner_open=true}}var checkInHasChecked=function(){var g=$("#department_employee_in").find(".el_empList");var l=[];for(var f=0,a=g.length;f<a;f++){l[f]=g[f].id}var h=$("#innerEmployeeTable").find(".el_checks");for(var d=0,c=l.length;d<c;d++){for(var e=0,b=h.length;e<b;e++){if(l[d]==h[e].value){h[e].checked="checked";break}}}};var seleInnerEmployee=function(){$("[name='employeeFlag']").val("111");var a=$("input[name='employeeIn']:checked");$("#innerEmployeeDiv").html("");var b=$("#department_employee_in").find(".panel-body");for(var g=0,d=b.length;g<d;g++){$(b[g]).html("")}var e=$("#department_employee_in").find(".employeeNum");for(var f=0,d=e.length;f<d;f++){$(e[f]).text("0")}for(var h=0,c=a.length;h<c;h++){var o=$(a[h]).parents("tr").children("td").eq(0).find(".departmentId").val();var l=$(a[h]).parents("tr").children("td").eq("4").html();var n=$(a[h]).parents("tr").children("td").eq("3").html();var m=$(a[h]).parents("tr").children("td").eq("1").html();$("#"+l+" .panel-body").append('<span class="el_empList" id="'+n+'">'+m+'<img class="el_empDelete" src="'+contextPath+'/image/delete.png" /></span>');$("#"+l+" .employeeNum").text(parseInt($("#"+l+" .employeeNum").text())+1);var p=$(a[h]).val();$("#innerEmployeeDiv").append('<input type="hidden" name="exam.employeeInExams['+h+'].employeeid" value="'+p+'"/>');$("#innerEmployeeDiv").append('<input type="hidden" name="exam.employeeInExams['+h+'].employeename" value="'+m+'"/>');$("#innerEmployeeDiv").append('<input type="hidden" name="exam.employeeInExams['+h+'].unitid" value="'+o+'"/>')}$("#outEmployeeDiv").html("");$("#innerEmployeeModal").modal("hide")};var queryOutEmployee=function(){var b=$("#el_chooseUnit").text();var a=$("#exam_level").val();if(a==""){alert("请先选择考试级别");return}if(b.length>0){b=b.substring(0,b.length-1);$("input[name='queryOuterEmployeesCondition.units']").val(b);ajaxQueryEmployeeOut()}else{alert("至少选择一个外部单位");return}};var ajaxQueryEmployeeOut=function(){$.ajax({url:contextPath+"/exam_getEmployeeOuts4Exam.action",data:$("#queryOutForm").serialize(),type:"POST",dataType:"json",success:showEmployeeOutModal,error:function(){alert("查询外来员工出错！！！")}})};function showEmployeeOutModal(b){$("#outEmployeeTable").html("");var h=b.examEmployeeOuts;for(var c=0,f=h.length;c<f;c++){var e=h[c].sex=="1"?"男":"女";var g=h[c].trainStatus;var d;var a='<tr><td><input type="checkbox" name="employeeOut" value="'+h[c].idCode+'" class="el_checks" /></td><td>'+h[c].name+"</td><td>"+e+"</td><td>"+h[c].idCode+"</td><td>"+h[c].unitname+"</td><td>"+h[c].empType+"</td><td>"+h[c].minusNum+'<input type="hidden" class="unitId" value="'+h[c].unitId+'"/><input type="hidden" class="bigemployeeoutid" value="'+h[c].bigemployeeoutid+'"/><input type="hidden" class="distributeid" value="'+h[c].distributeid+'"/> </td></tr>';$("#outEmployeeTable").append(a)}checkOutHasChecked();if(!out_open){$("#outEmployeeModal").modal({backdrop:"static",keyboard:false});out_open=true}}var checkOutHasChecked=function(){var b=$("#department_employee_out").find(".el_empList");var l=[];for(var h=0,c=b.length;h<c;h++){l[h]=b[h].id}var a=$("#outEmployeeTable").find(".el_checks");for(var f=0,e=l.length;f<e;f++){for(var g=0,d=a.length;g<d;g++){if(l[f]==a[g].value){a[g].checked="checked";break}}}};var selectOutEmployee=function(){$("[name='employeeFlag']").val("111");var n=$("input[name='employeeOut']:checked");$("#outEmployeeDiv").html("");var q=$("#department_employee_out").find(".panel-body");for(var h=0,e=q.length;h<e;h++){$(q[h]).html("")}var m=$("#department_employee_out").find(".employeeNum");for(var f=0,e=q.length;f<e;f++){$(m[f]).text("0")}for(var l=0,d=n.length;l<d;l++){var c=$(n[l]).parents("tr").children("td").eq("4").html();var p=$(n[l]).parents("tr").children("td").eq("3").html();var o=$(n[l]).parents("tr").children("td:last").find(".distributeid").val();var a=$(n[l]).parents("tr").children("td:last").find(".bigemployeeoutid").val();var g=$(n[l]).parents("tr").children("td:last").find(".unitId").val();var b=$(n[l]).parents("tr").children("td").eq("1").html();$("#"+c+" .panel-body").append('<span class="el_empList" id="'+p+'">'+b+'<img class="el_empDelete" src="'+contextPath+'/image/delete.png" /></span>');$("#"+c+" .employeeNum").text(parseInt($("#"+c+" .employeeNum").text())+1);var r=$(n[l]).val();$("#outEmployeeDiv").append('<input type="hidden" name="exam.employeeOutExams['+l+'].employeeid" value="'+r+'"/>');$("#outEmployeeDiv").append('<input type="hidden" name="exam.employeeOutExams['+l+'].employeename" value="'+b+'"/>');$("#outEmployeeDiv").append('<input type="hidden" name="exam.employeeOutExams['+l+'].unitid" value="'+g+'"/>');$("#outEmployeeDiv").append('<input type="hidden" name="exam.employeeOutExams['+l+'].distributeid" value="'+o+'"/>');$("#outEmployeeDiv").append('<input type="hidden" name="exam.employeeOutExams['+l+'].bigemployeeoutid" value="'+a+'"/>')}$("#innerEmployeeDiv").html("");$("#outEmployeeModal").modal("hide")};$(function(){searchDepartmentTree();$("#el_chooseDepart1").click(function(){if($("#treeDemo10").css("display")=="none"){$("#treeDemo10").show()}else{$("#treeDemo10").hide()}});searchPaper();$("#querBtn").click(function(){$("#currentPage").val("");searchPaper()})});function queryHaulUnit(){var a=$("#bigName").val();$("[name='queryOuterEmployeesCondition.bigId']").val(a);$.post(contextPath+"/unit_getUnitidsAndNamesByHaulId.action",{bigId:a},function(c){$("#haulUnitDiv").html("");if(c!=null&&c.unitidsAndNames!=null){var b=c.unitidsAndNames;for(var d=0,e=b.length;d<e;d++){$("#haulUnitDiv").append('<span><input type="checkbox" value="'+b[d].unitId+'" style="margin-left: 20px;" /><span>'+b[d].name+"</span></span>")}}},"json")}function openUnitModal(){$("#unitModal").modal({keyboard:false,backdrop:"static"})}function searchPaper(){$.ajax({url:"findPaper_findPapers.action",data:{currentPage:$("#currentPage").val(),currentCount:$("#currentCount").val(),title:$("#title").val(),level:$("#paper_level").val(),paperStatus:$("#paperStatus option:selected").val()},type:"POST",async:true,dataType:"text",success:showTable,error:function(){alert("请求失败！")}})}function showTable(data){var result=eval("("+data+")");var currentPage=result.pageBean.currentPage;var totalCount=result.pageBean.totalCount;var currentCount=result.pageBean.currentCount;$("#paperTableBody").html("");var papers=result.pageBean.productList;for(var i=0,length=papers.length;i<length;i++){$("#paperTableBody").append("<tr><td><input type='radio' onclick='setPaperIdValue()' name='exam.paperid_1' value='"+papers[i].paperid+"'/></td><td>"+papers[i].title+"</td><td>"+replaceLevel(papers[i].level)+"</td><td>"+papers[i].paperscore+"</td><td>"+papers[i].usetimes+"</td><td>"+papers[i].description+"</td><td>"+papers[i].employeename+"</td><td>"+papers[i].maketime+"</td><td><a href='/Exam/findPaper_findPaperAllInfoById.action?paperId="+papers[i].paperid+"' target='_blank'>试卷预览</a></td></tr>")}page(currentPage,totalCount,currentCount)}var setPaperIdValue=function(){$("[name='exam.paperid']").val($("[name='exam.paperid_1']:checked").val())};function page(c,a,b){$("#paginationID").pagination({total:a,pageSize:b,pageNumber:c,pageList:[8,15,20],layout:["list","sep","first","prev","manual","next","last","links"],onSelectPage:function(e,d){$("#currentPage").val(e);$("#currentCount").val(d);searchPaper()}})}var searchDepartmentTree=function(){var a;$.ajax({url:contextPath+"/exam_getDepartmentTree.action",async:true,dataType:"json",success:function(b){a=b.departmentTrees;geneDepartmentTree(a)},error:function(){alert("查询内部部门树失败！！！")}})};function geneDepartmentTree(b){$("#treeDemo10").html("");var a={view:{selectedMulti:false},check:{enable:true,chkboxType:{Y:"",N:""}},data:{simpleData:{enable:true,idKey:"departmentid",pIdKey:"updepartmentid",rootPId:null},key:{name:"departmentname",}},callback:{beforeCheck:beforeCheck,onClick:zTreeOnClick,onCheck:zTreeOnCheck}};var c=b;$.fn.zTree.init($("#treeDemo10"),a,c)}function zTreeOnClick(a,c,b){}function zTreeOnCheck(a,c,b){}var el_chooseDepart1,className10="dark",el_id;function beforeCheck(b,a){className10=(className10==="dark"?"":"dark");el_id=a.departmentid;if(!a.checked){departmentIds+=a.departmentid+",";showLog10(a.departmentname+",");$("#department_employee_in").append('<div class="panel panel-default el_departPersons" id="'+a.departmentname+'"><div class="panel-heading"><span class="el_addDepart" >'+a.departmentname+'</span>&nbsp;&nbsp;(人数：<span class="employeeNum">0</span>)</div><div class="panel-body"></div></div>')}else{departmentIds=departmentIds.replace(a.departmentid+",","");$("#"+a.departmentname).remove();noshowLog10(a.departmentname+",",a);var c=a.getParentNode()}return(a.doCheck!==false)}function showLog10(a){if(!el_chooseDepart1){el_chooseDepart1=$("#el_chooseDepart1")}el_chooseDepart1.append("<li class='"+className10+"' id='"+el_id+"'>"+a+"</li>")}function noshowLog10(e,d){if(!el_chooseDepart1){el_chooseDepart1=$("#el_chooseDepart1")}el_chooseDepart1.children("#"+el_id).remove();if(d.isParent){var a=d.children;if(a){for(var b=0;b<a.length;b++){var c=a.departmentId;el_chooseDepart1.children("#"+c).remove()}}}}function checkNode10(h){var c=$.fn.zTree.getZTreeObj("treeDemo10"),f=h.data.type,b=c.getSelectedNodes();if(f.indexOf("All")<0&&b.length==0){alert("请先选择一个节点")}if(f=="checkAllTrue"){c.checkAllNodes(true)}else{if(f=="checkAllFalse"){c.checkAllNodes(false)}else{var g=$("#callbackTrigger").attr("checked");for(var d=0,a=b.length;d<a;d++){if(f=="checkTrue"){c.checkNode10(b[d],true,false,g)}else{if(f=="checkFalse"){c.checkNode10(b[d],false,false,g)}else{if(f=="toggle"){c.checkNode10(b[d],null,false,g)}else{if(f=="checkTruePS"){c.checkNode10(b[d],true,true,g)}else{if(f=="checkFalsePS"){c.checkNode10(b[d],false,true,g)}else{if(f=="togglePS"){c.checkNode10(b[d],null,true,g)}}}}}}}}}}function setAutoTrigger10(b){var a=$.fn.zTree.getZTreeObj("treeDemo10");a.setting10.check.autoCheckTrigger=$("#autoCallbackTrigger").attr("checked");$("#autoCheckTriggerValue").html(a.setting10.check.autoCheckTrigger?"true":"false")}var saveExam=function(){$.validator.methods.compareDate=function(f,c,g){var b=$("#inpstart0").val();var e=new Date(b);var d=new Date(f);return e<=d};var a=$("#examForm").validate({ignore:[],rules:{"exam.paperid":"required","exam.examname":{required:true},"exam.traincontent":{required:true},"exam.xueshi":{required:true,digits:true},"exam.answertime":{required:true,digits:true,range:[20,400]},"exam.address":"required","exam.examlevel":"required","exam.starttime":"required","exam.endtime":{required:true},"exam.employeename":{required:true},employeeFlag:"required"},messages:{"exam.paperid":{required:"必须选择一份考试试卷"},"exam.examname":{required:"考试名称不能为空"},"exam.traincontent":{required:"培训内容不能为空"},"exam.xueshi":{required:"培训时长不能为空",digits:"必须输入整数"},"exam.examlevel":{required:"考试等级不能为空"},"exam.answertime":{required:"考试时长不能为空",digits:"考试时长必须是整数",range:"考试时长必须在20到400分钟范围内"},"exam.address":"考试地址不能为空","exam.starttime":"开始时间不能为空","exam.endtime":{required:"结束时间不能为空"},"exam.employeename":{required:"创建人不能为空"},employeeFlag:"必须选择参考员工"}});if(a.form()){if(confirm("确认保存考试并退出?")){$("#saveExamBtn").prop("disabled",true);$.ajax({url:contextPath+"/exam_addExam.action",data:$("#examForm").serialize(),type:"POST",dataType:"json",async:true,success:function(b){alert(b.result);if(b.result=="添加成功！"){window.location.href=contextPath+"/view/examParper/exam/examManage.jsp"}},error:function(){alert("保存试卷失败！！！")}})}}};function queryPaper(b){var a=$(b).children("option:selected").val();$("#paper_level").val(a);$("[name='exam.paperid']").val("");$("#level option[value='"+a+"']").prop("selected","selected");$("[name='queryOuterEmployeesCondition.trainStatus']").val((parseInt(a)).toString());searchPaper()}function queryBigNameAndId(){$.post(contextPath+"/haul_getHaulNameAndIdsForExam.action",add2Select,"json")}function add2Select(a){if(a!=null&&a.haulNameAndIds!=null){var c=a.haulNameAndIds;for(var b=0,d=c.length;b<d;b++){$("#bigName").append('<option value="'+c[b].bigId+'">'+c[b].bigName+"</option>")}}}function addUnit2Input(){$("#haulUnitDiv :checkbox").each(function(d){var e=$(this).val();var c=$(this).siblings("span").text();var b=$("#department_employee_out").children("#"+c);var a=$("#el_chooseUnit").children("#"+e);if($(this).prop("checked")==false){if(b.length==1&&a.length==1){$("#department_employee_out").children("#"+c).remove();$("#el_chooseUnit").children("#"+e).remove()}}else{if(b.length==0&&a.length==0){$("#department_employee_out").append('<div class="panel panel-default el_departPersons" id="'+c+'"><div class="panel-heading"><span class="el_addDepart" >'+c+'</span>&nbsp;&nbsp;(人数：<span class="employeeNum">0</span>)</div><div class="panel-body"></div></div>');$("#el_chooseUnit").append("<li class='"+c+"' id='"+e+"'>"+c+",</li>")}}});$("#unitModal").modal("hide")}function initEmployeeTypeDic(){$.post(contextPath+"/dic_getDicNamesByUpid.action",{upId:"100"},showEmployeeTypeDic,"json")}function showEmployeeTypeDic(a){if(a!=null&&a.names!=null){var c=a.names;for(var b=0;b<c.length;b++){$("#employType").append('<option value="'+c[b]+'">'+c[b]+"</option>")}}}function replaceLevel(a){if(a=="1"){return"厂级"}if(a=="2"){return"部门级"}if(a=="3"){return"班组级"}}function getServerDate(){var a;$.ajax({url:"onlineExam_getNowServerTime.action?date="+Format(new Date(),"HH:mm:ss"),async:false,datatype:"json",success:function(b){a=b.nowTime.replace(/T/g," ").replace(/-/g,"/")}});return new Date(a)}function findNames(c){$("#showDiv").html("");var b=$(c).val();var a="";$.post(contextPath+"/exam_getExamNameAndLevelByWord.action",{nameWord:b},function(d){if(d.nameAndLevel!=null&&d.nameAndLevel.length>0){for(var e=0;e<d.nameAndLevel.length;e++){a+="<div style='padding:5px;cursor:pointer;' class='unitName' onclick='clickFn(this)' onmouseover='overFun(this);' onmouseout='outFn(this);'>"+d.nameAndLevel[e].examName+"<input class='examlevel' type='hidden' value='"+d.nameAndLevel[e].examlevel+"'/><input class='traincontent' type='hidden' value='"+d.nameAndLevel[e].traincontent+"'/><input class='xueshi' type='hidden' value='"+d.nameAndLevel[e].xueshi+"'/></div>"}$("#showDiv").css("display","block");$("#showDiv").html(a)}},"json")}function overFun(a){$(a).css("background","#C0C1C5")}function outFn(a){$(a).css("background","#fff")}function clickFn(e){var b=$(e).text();$("[name='exam.examname']").val(b);var d=$(e).find(".examlevel").val();$("[name='exam.examlevel'] option[value='"+d+"']").prop("selected",true);var c=$(e).find(".traincontent").val();$("[name='exam.traincontent']").val(c);var a=$(e).find(".xueshi").val();$("[name='exam.xueshi']").val(a);$("#showDiv").css("display","none");queryPaper($("#exam_level"))};